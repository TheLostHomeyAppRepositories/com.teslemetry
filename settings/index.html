<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Teslemetry Settings</title>
        <script
            type="text/javascript"
            src="/homey.js"
            data-origin="settings"
        ></script>
        <style>
            * {
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, sans-serif;
                margin: 0;
                padding: 20px;
                background-color: #f5f5f5;
                color: #333;
            }

            .container {
                max-width: 500px;
                margin: 0 auto;
            }

            h1 {
                font-size: 24px;
                margin-bottom: 20px;
                color: #3d6db5;
            }

            .card {
                background: white;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                margin-bottom: 20px;
            }

            .status {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 15px;
            }

            .status-indicator {
                width: 12px;
                height: 12px;
                border-radius: 50%;
            }

            .status-indicator.connected {
                background-color: #4caf50;
            }

            .status-indicator.disconnected {
                background-color: #f44336;
            }

            .status-text {
                font-weight: 500;
            }

            .description {
                color: #666;
                font-size: 14px;
                line-height: 1.5;
                margin-bottom: 20px;
            }

            button {
                width: 100%;
                padding: 12px 20px;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 500;
                cursor: pointer;
                transition:
                    background-color 0.2s,
                    opacity 0.2s;
            }

            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .btn-primary {
                background-color: #3d6db5;
                color: white;
            }

            .btn-primary:hover:not(:disabled) {
                background-color: #2d5a9e;
            }

            .btn-danger {
                background-color: #f44336;
                color: white;
            }

            .btn-danger:hover:not(:disabled) {
                background-color: #d32f2f;
            }

            .hidden {
                display: none;
            }

            .loading {
                text-align: center;
                padding: 40px;
                color: #666;
            }

            .spinner {
                width: 40px;
                height: 40px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #3d6db5;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 15px;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .info-box {
                background-color: #e3f2fd;
                border-left: 4px solid #3d6db5;
                padding: 12px 15px;
                margin-top: 15px;
                border-radius: 0 8px 8px 0;
                font-size: 14px;
                color: #1565c0;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Teslemetry Connection</h1>

            <div id="loading" class="card loading">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>

            <div id="connected-view" class="card hidden">
                <div class="status">
                    <div class="status-indicator connected"></div>
                    <span class="status-text">Connected to Teslemetry</span>
                </div>
                <p class="description">
                    Your Homey is connected to Teslemetry. If you want to
                    disconnect and remove your credentials, click the button
                    below.
                </p>
                <button id="disconnect-btn" class="btn-danger">
                    Disconnect
                </button>
                <div class="info-box">
                    Note: Disconnecting will remove your stored credentials. You
                    will need to reconnect by adding a new device.
                </div>
            </div>

            <div id="disconnected-view" class="card hidden">
                <div class="status">
                    <div class="status-indicator disconnected"></div>
                    <span class="status-text">Not Connected</span>
                </div>
                <p class="description">
                    Your Homey is not connected to Teslemetry. To connect, go to
                    Devices and add a new Tesla vehicle or energy device.
                </p>
            </div>
        </div>

        <script type="text/javascript">
            function onHomeyReady(Homey) {
                Homey.ready();

                checkConnectionStatus(Homey);

                document
                    .getElementById("disconnect-btn")
                    .addEventListener("click", function () {
                        disconnect(Homey);
                    });
            }

            function checkConnectionStatus(Homey) {
                Homey.api("GET", "/oauth/status", function (err, result) {
                    if (err) {
                        console.error("Failed to check status:", err);
                        showView(false);
                        return;
                    }
                    showView(result.connected);
                });
            }

            function showView(connected) {
                document.getElementById("loading").classList.add("hidden");

                if (connected) {
                    document
                        .getElementById("connected-view")
                        .classList.remove("hidden");
                    document
                        .getElementById("disconnected-view")
                        .classList.add("hidden");
                } else {
                    document
                        .getElementById("connected-view")
                        .classList.add("hidden");
                    document
                        .getElementById("disconnected-view")
                        .classList.remove("hidden");
                }
            }

            function disconnect(Homey) {
                Homey.confirm(
                    "Are you sure you want to disconnect? This will remove your stored credentials and you will need to reconnect by adding a new device.",
                    "warning",
                    function (err, confirmed) {
                        if (err || !confirmed) {
                            return;
                        }

                        var btn = document.getElementById("disconnect-btn");
                        btn.disabled = true;
                        btn.textContent = "Disconnecting...";

                        Homey.api(
                            "DELETE",
                            "/oauth/token",
                            function (err, result) {
                                btn.disabled = false;
                                btn.textContent = "Disconnect";

                                if (err) {
                                    console.error("Failed to disconnect:", err);
                                    Homey.alert(
                                        "Failed to disconnect: " +
                                            (err.message || err),
                                    );
                                    return;
                                }

                                Homey.alert(
                                    "Successfully disconnected from Teslemetry.",
                                );
                                showView(false);
                            },
                        );
                    },
                );
            }
        </script>
    </body>
</html>
